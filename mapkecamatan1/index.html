<!doctype html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <title>WebGIS Desa Badamita</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- QGIS2Web CSS -->
    <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
    <link rel="stylesheet" href="css/qgis2web.css">
    <link rel="stylesheet" href="css/leaflet.photon.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        
        #map {
            width: 100%;
            height: 100vh;
        }
        
        /* Catalog Sidebar */
        .catalog-sidebar {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 280px;
            max-height: calc(100vh - 20px);
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .catalog-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .catalog-header i {
            margin-right: 8px;
        }
        
        .toggle-catalog {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .catalog-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .layer-group {
            margin-bottom: 15px;
        }
        
        .layer-group-title {
            font-weight: bold;
            font-size: 13px;
            color: #333;
            padding: 8px 10px;
            background: #f0f0f0;
            border-radius: 5px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .layer-group-title i {
            font-size: 10px;
            transition: transform 0.3s;
        }
        
        .layer-group-title.collapsed i {
            transform: rotate(-90deg);
        }
        
        .layer-item {
            display: flex;
            align-items: center;
            padding: 6px 10px 6px 20px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .layer-item:hover {
            background: #f5f5f5;
        }
        
        .layer-item input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }
        
        .layer-legend {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        
        .layer-content {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .layer-content.collapsed {
            max-height: 0;
        }
        
        /* Search Box */
        .search-box {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 300px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
        }
        
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        .search-results {
            max-height: 300px;
            overflow-y: auto;
            border-top: 1px solid #eee;
            display: none;
        }
        
        .search-result-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f5f5f5;
            font-size: 13px;
        }
        
        .search-result-item:hover {
            background: #f5f5f5;
        }
        
        .search-result-type {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }
        
        /* Compass */
        .compass-control {
            position: absolute;
            bottom: 120px;
            right: 10px;
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .compass-control:hover {
            transform: scale(1.1);
        }
        
        .compass-control i {
            font-size: 24px;
            color: #667eea;
        }
        
        /* Location Button */
        .location-btn {
            position: absolute;
            bottom: 60px;
            right: 10px;
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
        }
        
        .location-btn:hover {
            background: #f0f0f0;
        }
        
        .location-btn i {
            font-size: 18px;
            color: #667eea;
        }
        
        /* Basemap Selector */
        .basemap-selector {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            display: flex;
            padding: 5px;
        }
        
        .basemap-btn {
            padding: 8px 15px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 12px;
            border-radius: 5px;
            transition: all 0.2s;
        }
        
        .basemap-btn:hover {
            background: #f0f0f0;
        }
        
        .basemap-btn.active {
            background: #667eea;
            color: white;
        }
        
        /* Zoom Controls */
        .leaflet-control-zoom {
            border-radius: 8px !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3) !important;
            border: none !important;
        }
        
        .leaflet-control-zoom a {
            width: 40px !important;
            height: 40px !important;
            line-height: 40px !important;
            font-size: 20px !important;
        }
        
        /* Loading Indicator */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9);
            padding: 20px 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 2000;
            display: none;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .catalog-sidebar {
                width: 250px;
            }
            .search-box {
                width: 250px;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- Catalog Sidebar -->
    <div class="catalog-sidebar">
        <div class="catalog-header">
            <div><i class="fas fa-layer-group"></i> Katalog Layer</div>
            <button class="toggle-catalog" onclick="toggleCatalog()">
                <i class="fas fa-minus"></i>
            </button>
        </div>
        <div class="catalog-content" id="catalogContent">
            <!-- Administrasi -->
            <div class="layer-group">
                <div class="layer-group-title" onclick="toggleGroup(this)">
                    <span><i class="fas fa-landmark"></i> Administrasi</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="layer-content">
                    <div class="layer-item">
                        <input type="checkbox" id="toggle_batas" checked onchange="toggleLayer('batas')">
                        <div class="layer-legend" style="background: #6c757d; border-width: 3px"></div>
                        <label for="toggle_batas">Batas Wilayah</label>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" id="toggle_4desa" checked onchange="toggleLayer('4desa')">
                        <div class="layer-legend" style="background: rgba(183,228,199,0.5)"></div>
                        <label for="toggle_4desa">4 Desa</label>
                    </div>
                </div>
            </div>
            
            <!-- RW -->
            <div class="layer-group">
                <div class="layer-group-title" onclick="toggleGroup(this)">
                    <span><i class="fas fa-draw-polygon"></i> RW</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="layer-content">
                    <div class="layer-item">
                        <input type="checkbox" id="toggle_rw1" checked onchange="toggleLayer('rw1')">
                        <div class="layer-legend" style="background: rgba(166,199,229,0.7)"></div>
                        <label for="toggle_rw1">RW 1 Badamita</label>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" id="toggle_rw2" checked onchange="toggleLayer('rw2')">
                        <div class="layer-legend" style="background: rgba(244,169,162,0.7)"></div>
                        <label for="toggle_rw2">RW 2 Karangsaga</label>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" id="toggle_rw3" checked onchange="toggleLayer('rw3')">
                        <div class="layer-legend" style="background: rgba(253,191,111,0.7)"></div>
                        <label for="toggle_rw3">RW 3 Paguan</label>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" id="toggle_rw4" checked onchange="toggleLayer('rw4')">
                        <div class="layer-legend" style="background: rgba(229,181,205,0.7)"></div>
                        <label for="toggle_rw4">RW 4 Sokaraja</label>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" id="toggle_rw5" checked onchange="toggleLayer('rw5')">
                        <div class="layer-legend" style="background: rgba(183,227,205,0.7)"></div>
                        <label for="toggle_rw5">RW 5 Gendani</label>
                    </div>
                </div>
            </div>
            
            <!-- Penggunaan Lahan -->
            <div class="layer-group">
                <div class="layer-group-title" onclick="toggleGroup(this)">
                    <span><i class="fas fa-seedling"></i> Penggunaan Lahan</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="layer-content">
                    <div class="layer-item">
                        <input type="checkbox" id="toggle_sawah" checked onchange="toggleLayer('sawah')">
                        <div class="layer-legend" style="background: #5dbb59"></div>
                        <label for="toggle_sawah">Sawah</label>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" id="toggle_kebun" checked onchange="toggleLayer('kebun')">
                        <div class="layer-legend" style="background: #33a02c"></div>
                        <label for="toggle_kebun">Kebun</label>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" id="toggle_lapangan" checked onchange="toggleLayer('lapangan')">
                        <div class="layer-legend" style="background: #d5b43c"></div>
                        <label for="toggle_lapangan">Lapangan Desa</label>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" id="toggle_bangunan" checked onchange="toggleLayer('bangunan')">
                        <div class="layer-legend" style="background: #e0e0e0"></div>
                        <label for="toggle_bangunan">Bangunan</label>
                    </div>
                </div>
            </div>
            
            <!-- Infrastruktur -->
            <div class="layer-group">
                <div class="layer-group-title" onclick="toggleGroup(this)">
                    <span><i class="fas fa-road"></i> Infrastruktur</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="layer-content">
                    <div class="layer-item">
                        <input type="checkbox" id="toggle_jalan" checked onchange="toggleLayer('jalan')">
                        <div class="layer-legend" style="background: #8d8d8d; height: 3px"></div>
                        <label for="toggle_jalan">Jalan</label>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" id="toggle_sungai" checked onchange="toggleLayer('sungai')">
                        <div class="layer-legend" style="background: #70bad4; height: 3px"></div>
                        <label for="toggle_sungai">Sungai</label>
                    </div>
                </div>
            </div>
            
            <!-- Fasilitas Umum -->
            <div class="layer-group">
                <div class="layer-group-title" onclick="toggleGroup(this)">
                    <span><i class="fas fa-building"></i> Fasilitas Umum</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="layer-content">
                    <div class="layer-item">
                        <input type="checkbox" id="toggle_pemerintahan" checked onchange="toggleLayer('pemerintahan')">
                        <i class="fas fa-landmark" style="width: 16px; margin-right: 8px; color: #dc3545"></i>
                        <label for="toggle_pemerintahan">Pemerintahan</label>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" id="toggle_pendidikan" checked onchange="toggleLayer('pendidikan')">
                        <i class="fas fa-graduation-cap" style="width: 16px; margin-right: 8px; color: #007bff"></i>
                        <label for="toggle_pendidikan">Pendidikan</label>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" id="toggle_kesehatan" checked onchange="toggleLayer('kesehatan')">
                        <i class="fas fa-hospital" style="width: 16px; margin-right: 8px; color: #28a745"></i>
                        <label for="toggle_kesehatan">Kesehatan</label>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" id="toggle_ibadah" checked onchange="toggleLayer('ibadah')">
                        <i class="fas fa-mosque" style="width: 16px; margin-right: 8px; color: #17a2b8"></i>
                        <label for="toggle_ibadah">Tempat Ibadah</label>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" id="toggle_pemakaman" checked onchange="toggleLayer('pemakaman')">
                        <i class="fas fa-monument" style="width: 16px; margin-right: 8px; color: #6c757d"></i>
                        <label for="toggle_pemakaman">Pemakaman</label>
                    </div>
                </div>
            </div>
            
            <!-- Ekonomi -->
            <div class="layer-group">
                <div class="layer-group-title" onclick="toggleGroup(this)">
                    <span><i class="fas fa-shopping-cart"></i> Ekonomi</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="layer-content">
                    <div class="layer-item">
                        <input type="checkbox" id="toggle_market" checked onchange="toggleLayer('market')">
                        <i class="fas fa-store" style="width: 16px; margin-right: 8px; color: #fd7e14"></i>
                        <label for="toggle_market">Market</label>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" id="toggle_alfamart" checked onchange="toggleLayer('alfamart')">
                        <i class="fas fa-shopping-basket" style="width: 16px; margin-right: 8px; color: #e83e8c"></i>
                        <label for="toggle_alfamart">Alfamart</label>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" id="toggle_umkm" checked onchange="toggleLayer('umkm')">
                        <i class="fas fa-store-alt" style="width: 16px; margin-right: 8px; color: #6f42c1"></i>
                        <label for="toggle_umkm">UMKM</label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Search Box -->
    <div class="search-box">
        <input type="text" class="search-input" id="searchInput" placeholder="Cari lokasi, fasilitas...">
        <i class="fas fa-search search-icon"></i>
        <div class="search-results" id="searchResults"></div>
    </div>
    
    <!-- Compass -->
    <div class="compass-control" title="Reset Orientasi" onclick="resetView()">
        <i class="fas fa-compass"></i>
    </div>
    
    <!-- Location Button -->
    <button class="location-btn" onclick="locateUser()" title="Lokasi Saya">
        <i class="fas fa-location-arrow"></i>
    </button>
    
    <!-- Basemap Selector -->
    <div class="basemap-selector">
        <button class="basemap-btn active" onclick="changeBasemap('osm')">
            <i class="fas fa-map"></i> OSM
        </button>
        <button class="basemap-btn" onclick="changeBasemap('satellite')">
            <i class="fas fa-satellite"></i> Satellite
        </button>
        <button class="basemap-btn" onclick="changeBasemap('terrain')">
            <i class="fas fa-mountain"></i> Terrain
        </button>
    </div>
    
    <!-- Loading -->
    <div class="loading" id="loading">
        <i class="fas fa-spinner fa-spin"></i> Loading...
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <!-- QGIS2Web Scripts -->
    <script src="js/qgis2web_expressions.js"></script>
    <script src="js/leaflet.rotatedMarker.js"></script>
    <script src="js/leaflet.pattern.js"></script>
    <script src="js/leaflet-hash.js"></script>
    <script src="js/Autolinker.min.js"></script>
    <script src="js/rbush.min.js"></script>
    <script src="js/labelgun.min.js"></script>
    <script src="js/labels.js"></script>
    
    <!-- GeoJSON Data -->
    <script src="data/Sawah_0.js"></script>
    <script src="data/Kebun_1.js"></script>
    <script src="data/LapanganDesa_2.js"></script>
    <script src="data/DesaBadamita_3.js"></script>
    <script src="data/RW5GENDANI_4.js"></script>
    <script src="data/RW4SOKARAJA_5.js"></script>
    <script src="data/RW3PAGUAN_6.js"></script>
    <script src="data/RW2KARANGSAGA_7.js"></script>
    <script src="data/RW1BADAMITA_8.js"></script>
    <script src="data/RTDIRW5GENDANI_9.js"></script>
    <script src="data/RTDIRW4SOKARAJA_10.js"></script>
    <script src="data/RTDIRW3PAGUAN_11.js"></script>
    <script src="data/RTDIRW2KARANGSAGA_12.js"></script>
    <script src="data/RTDIRW1BADAMITA_13.js"></script>
    <script src="data/bangunan_14.js"></script>
    <script src="data/uaskecamatandesa_15.js"></script>
    <script src="data/4Desa_16.js"></script>
    <script src="data/batas_17.js"></script>
    <script src="data/Sungai_18.js"></script>
    <script src="data/Jalan_19.js"></script>
    <script src="data/Market_21.js"></script>
    <script src="data/Alfamart_22.js"></script>
    <script src="data/UMKM_23.js"></script>
    <script src="data/TempatIbadah_24.js"></script>
    <script src="data/TempatPemakaman_25.js"></script>
    <script src="data/FasilitasKesehatan_26.js"></script>
    <script src="data/Pendidikan_27.js"></script>
    <script src="data/pemerintahan_29.js"></script>
    
    <script>
        // Initialize map dengan bounds dari QGIS
        var map = L.map('map', {
            zoomControl: false,
            maxZoom: 28,
            minZoom: 1
        }).fitBounds([[-7.446586743305874,109.49189937622862],[-7.365365842087494,109.62972878435679]]);
        
        // Zoom control
        L.control.zoom({
            position: 'topright'
        }).addTo(map);
        
        // Autolinker untuk popup
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
        
        // Helper functions dari QGIS2Web
        function removeEmptyRowsFromPopupContent(content, feature) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            var rows = tempDiv.querySelectorAll('tr');
            for (var i = 0; i < rows.length; i++) {
                var td = rows[i].querySelector('td.visible-with-data');
                var key = td ? td.id : '';
                if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                    rows[i].parentNode.removeChild(rows[i]);
                }
            }
            return tempDiv.innerHTML;
        }
        
        function addClassToPopupIfMedia(content, popup) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            if (tempDiv.querySelector('td img')) {
                popup._contentNode.classList.add('media');
                setTimeout(function() {
                    popup.update();
                }, 10);
            } else {
                popup._contentNode.classList.remove('media');
            }
        }
        
        // Base maps
        const basemaps = {
            osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© Esri'
            }),
            terrain: L.tileLayer('https://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', {
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                attribution: '¬© Google'
            })
        };
        
        let currentBasemap = basemaps.osm.addTo(map);
        
        // Layer storage
        const layerMap = {};
        const searchData = [];
        
        // Change basemap function
        function changeBasemap(type) {
            map.removeLayer(currentBasemap);
            currentBasemap = basemaps[type].addTo(map);
            currentBasemap.bringToBack();
            
            // Update active button
            document.querySelectorAll('.basemap-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.basemap-btn').classList.add('active');
        }
        
        // Toggle catalog
        function toggleCatalog() {
            const content = document.getElementById('catalogContent');
            const icon = event.target.querySelector('i') || event.target;
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.className = 'fas fa-minus';
            } else {
                content.style.display = 'none';
                icon.className = 'fas fa-plus';
            }
        }
        
        // Toggle group
        function toggleGroup(element) {
            const content = element.nextElementSibling;
            const icon = element.querySelector('.fa-chevron-down');
            
            element.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
        }
        
        // Reset view
        function resetView() {
            map.fitBounds([[-7.446586743305874,109.49189937622862],[-7.365365842087494,109.62972878435679]]);
        }
        
        // Locate user
        function locateUser() {
            map.locate({setView: true, maxZoom: 16});
        }
        
        map.on('locationfound', function(e) {
            L.marker(e.latlng).addTo(map).bindPopup('Anda disini').openPopup();
        });
        
        // Toggle layer visibility
        function toggleLayer(layerId) {
            const layer = layerMap[layerId];
            if (layer) {
                if (map.hasLayer(layer)) {
                    map.removeLayer(layer);
                } else {
                    map.addLayer(layer);
                }
            }
        }
        
        // ==================== LAYER DEFINITIONS ====================
        
        // Function to create popup content
        function createPopup(properties) {
            let content = '<table style="font-size: 12px;">';
            for (let key in properties) {
                if (properties[key] !== null && properties[key] !== '' && key !== 'fid') {
                    content += `<tr><th>${key}</th><td>${properties[key]}</td></tr>`;
                }
            }
            content += '</table>';
            return content;
        }
        
        // SAWAH LAYER
        if (typeof json_Sawah_0 !== 'undefined') {
            layerMap.sawah = L.geoJSON(json_Sawah_0, {
                style: {
                    color: 'rgba(35,35,35,1.0)',
                    weight: 1,
                    fillColor: 'rgba(93,187,89,1.0)',
                    fillOpacity: 1
                },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(createPopup(feature.properties));
                }
            }).addTo(map);
        }
        
        // KEBUN LAYER
        if (typeof json_Kebun_1 !== 'undefined') {
            layerMap.kebun = L.geoJSON(json_Kebun_1, {
                style: {
                    color: 'rgba(35,35,35,1.0)',
                    weight: 1,
                    fillColor: 'rgba(51,160,44,1.0)',
                    fillOpacity: 1
                },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(createPopup(feature.properties));
                }
            }).addTo(map);
        }
        
        // LAPANGAN DESA LAYER
        if (typeof json_LapanganDesa_2 !== 'undefined') {
            layerMap.lapangan = L.geoJSON(json_LapanganDesa_2, {
                style: {
                    color: 'rgba(35,35,35,1.0)',
                    weight: 1,
                    fillColor: 'rgba(213,180,60,1.0)',
                    fillOpacity: 1
                },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(createPopup(feature.properties));
                    if (feature.properties.Lapangan) {
                        searchData.push({
                            name: feature.properties.Lapangan,
                            lat: layer.getBounds().getCenter().lat,
                            lng: layer.getBounds().getCenter().lng,
                            type: 'Lapangan'
                        });
                    }
                }
            }).addTo(map);
        }
        
        // RW LAYERS
        if (typeof json_RW1BADAMITA_8 !== 'undefined') {
            layerMap.rw1 = L.geoJSON(json_RW1BADAMITA_8, {
                style: {
                    color: 'rgba(0,0,0,1.0)',
                    dashArray: '35,7',
                    weight: 7,
                    fillColor: 'rgba(166,199,229,1.0)',
                    fillOpacity: 1
                },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(createPopup(feature.properties));
                }
            }).addTo(map);
        }
        
        if (typeof json_RW2KARANGSAGA_7 !== 'undefined') {
            layerMap.rw2 = L.geoJSON(json_RW2KARANGSAGA_7, {
                style: {
                    color: 'rgba(0,0,0,1.0)',
                    dashArray: '35,7',
                    weight: 7,
                    fillColor: 'rgba(244,169,162,1.0)',
                    fillOpacity: 1
                },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(createPopup(feature.properties));
                }
            }).addTo(map);
        }
        
        if (typeof json_RW3PAGUAN_6 !== 'undefined') {
            layerMap.rw3 = L.geoJSON(json_RW3PAGUAN_6, {
                style: {
                    color: 'rgba(0,0,0,1.0)',
                    dashArray: '35,7',
                    weight: 7,
                    fillColor: 'rgba(253,191,111,1.0)',
                    fillOpacity: 1
                },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(createPopup(feature.properties));
                }
            }).addTo(map);
        }
        
        if (typeof json_RW4SOKARAJA_5 !== 'undefined') {
            layerMap.rw4 = L.geoJSON(json_RW4SOKARAJA_5, {
                style: {
                    color: 'rgba(0,0,0,1.0)',
                    dashArray: '35,7',
                    weight: 7,
                    fillColor: 'rgba(229,181,205,1.0)',
                    fillOpacity: 1
                },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(createPopup(feature.properties));
                }
            }).addTo(map);
        }
        
        if (typeof json_RW5GENDANI_4 !== 'undefined') {
            layerMap.rw5 = L.geoJSON(json_RW5GENDANI_4, {
                style: {
                    color: 'rgba(0,0,0,1.0)',
                    dashArray: '35,7',
                    weight: 7,
                    fillColor: 'rgba(183,227,205,1.0)',
                    fillOpacity: 1
                },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(createPopup(feature.properties));
                }
            }).addTo(map);
        }
        
        // BANGUNAN LAYER
        if (typeof json_bangunan_14 !== 'undefined') {
            layerMap.bangunan = L.geoJSON(json_bangunan_14, {
                style: {
                    color: 'rgba(35,35,35,1.0)',
                    weight: 1,
                    fillColor: 'rgba(224,224,224,1.0)',
                    fillOpacity: 1
                },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(createPopup(feature.properties));
                }
            }).addTo(map);
        }
        
        // 4 DESA LAYER
        if (typeof json_4Desa_16 !== 'undefined') {
            layerMap['4desa'] = L.geoJSON(json_4Desa_16, {
                style: function(feature) {
                    const colors = {
                        'Badamita': 'rgba(255,202,212,1.0)',
                        'Lengkong': 'rgba(183,228,199,1.0)',
                        'Luwung': 'rgba(216,243,220,1.0)',
                        'Tanjunganom': 'rgba(241,232,217,1.0)'
                    };
                    return {
                        color: 'rgba(35,35,35,1.0)',
                        weight: 1,
                        fillColor: colors[feature.properties.NAMOBJ] || 'rgba(212,215,51,1.0)',
                        fillOpacity: 1
                    };
                },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(createPopup(feature.properties));
                }
            }).addTo(map);
        }
        
        // BATAS WILAYAH LAYER
        if (typeof json_batas_17 !== 'undefined') {
            layerMap.batas = L.geoJSON(json_batas_17, {
                style: {
                    color: 'rgba(108,117,125,1.0)',
                    weight: 4,
                    fillOpacity: 0
                },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(createPopup(feature.properties));
                }
            }).addTo(map);
        }
        
        // JALAN LAYER
        if (typeof json_Jalan_19 !== 'undefined') {
            layerMap.jalan = L.geoJSON(json_Jalan_19, {
                style: {
                    color: 'rgba(141,141,141,1.0)',
                    weight: 1
                },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(createPopup(feature.properties));
                }
            }).addTo(map);
        }
        
        // SUNGAI LAYER
        if (typeof json_Sungai_18 !== 'undefined') {
            layerMap.sungai = L.geoJSON(json_Sungai_18, {
                style: {
                    color: 'rgba(112,186,212,1.0)',
                    weight: 1
                },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(createPopup(feature.properties));
                }
            }).addTo(map);
        }
        
        // PEMERINTAHAN LAYER
        if (typeof json_pemerintahan_29 !== 'undefined') {
            layerMap.pemerintahan = L.geoJSON(json_pemerintahan_29, {
                pointToLayer: function(feature, latlng) {
                    if (feature.properties.NAMOBJ) {
                        searchData.push({
                            name: feature.properties.NAMOBJ,
                            lat: latlng.lat,
                            lng: latlng.lng,
                            type: 'Pemerintahan'
                        });
                    }
                    return L.marker(latlng, {
                        icon: L.divIcon({
                            html: '<i class="fas fa-landmark" style="color: #dc3545; font-size: 20px;"></i>',
                            className: '',
                            iconSize: [20, 20]
                        })
                    });
                },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(createPopup(feature.properties));
                }
            }).addTo(map);
        }
        
        // PENDIDIKAN LAYER
        if (typeof json_Pendidikan_27 !== 'undefined') {
            layerMap.pendidikan = L.geoJSON(json_Pendidikan_27, {
                pointToLayer: function(feature, latlng) {
                    if (feature.properties.NAMOBJ) {
                        searchData.push({
                            name: feature.properties.NAMOBJ,
                            lat: latlng.lat,
                            lng: latlng.lng,
                            type: 'Pendidikan'
                        });
                    }
                    return L.marker(latlng, {
                        icon: L.divIcon({
                            html: '<i class="fas fa-graduation-cap" style="color: #007bff; font-size: 18px;"></i>',
                            className: '',
                            iconSize: [20, 20]
                        })
                    });
                },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(createPopup(feature.properties));
                }
            }).addTo(map);
        }
        
        // KESEHATAN LAYER
        if (typeof json_FasilitasKesehatan_26 !== 'undefined') {
            layerMap.kesehatan = L.geoJSON(json_FasilitasKesehatan_26, {
                pointToLayer: function(feature, latlng) {
                    if (feature.properties.NAMOBJ) {
                        searchData.push({
                            name: feature.properties.NAMOBJ,
                            lat: latlng.lat,
                            lng: latlng.lng,
                            type: 'Kesehatan'
                        });
                    }
                    return L.marker(latlng, {
                        icon: L.divIcon({
                            html: '<i class="fas fa-hospital" style="color: #28a745; font-size: 18px;"></i>',
                            className: '',
                            iconSize: [20, 20]
                        })
                    });
                },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(createPopup(feature.properties));
                }
            }).addTo(map);
        }
        
        // TEMPAT IBADAH LAYER
        if (typeof json_TempatIbadah_24 !== 'undefined') {
            layerMap.ibadah = L.geoJSON(json_TempatIbadah_24, {
                pointToLayer: function(feature, latlng) {
                    if (feature.properties.NAMOBJ) {
                        searchData.push({
                            name: feature.properties.NAMOBJ,
                            lat: latlng.lat,
                            lng: latlng.lng,
                            type: 'Tempat Ibadah'
                        });
                    }
                    return L.marker(latlng, {
                        icon: L.divIcon({
                            html: '<i class="fas fa-mosque" style="color: #17a2b8; font-size: 18px;"></i>',
                            className: '',
                            iconSize: [20, 20]
                        })
                    });
                },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(createPopup(feature.properties));
                }
            }).addTo(map);
        }
        
        // PEMAKAMAN LAYER
        if (typeof json_TempatPemakaman_25 !== 'undefined') {
            layerMap.pemakaman = L.geoJSON(json_TempatPemakaman_25, {
                pointToLayer: function(feature, latlng) {
                    if (feature.properties.Kuburan) {
                        searchData.push({
                            name: feature.properties.Kuburan,
                            lat: latlng.lat,
                            lng: latlng.lng,
                            type: 'Pemakaman'
                        });
                    }
                    return L.marker(latlng, {
                        icon: L.divIcon({
                            html: '<i class="fas fa-monument" style="color: #6c757d; font-size: 18px;"></i>',
                            className: '',
                            iconSize: [20, 20]
                        })
                    });
                },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(createPopup(feature.properties));
                }
            }).addTo(map);
        }
        
        // MARKET LAYER
        if (typeof json_Market_21 !== 'undefined') {
            layerMap.market = L.geoJSON(json_Market_21, {
                pointToLayer: function(feature, latlng) {
                    if (feature.properties.Market) {
                        searchData.push({
                            name: feature.properties.Market,
                            lat: latlng.lat,
                            lng: latlng.lng,
                            type: 'Market'
                        });
                    }
                    return L.marker(latlng, {
                        icon: L.divIcon({
                            html: '<i class="fas fa-store" style="color: #fd7e14; font-size: 18px;"></i>',
                            className: '',
                            iconSize: [20, 20]
                        })
                    });
                },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(createPopup(feature.properties));
                }
            }).addTo(map);
        }
        
        // ALFAMART LAYER
        if (typeof json_Alfamart_22 !== 'undefined') {
            layerMap.alfamart = L.geoJSON(json_Alfamart_22, {
                pointToLayer: function(feature, latlng) {
                    if (feature.properties.Alfamart) {
                        searchData.push({
                            name: feature.properties.Alfamart,
                            lat: latlng.lat,
                            lng: latlng.lng,
                            type: 'Alfamart'
                        });
                    }
                    return L.marker(latlng, {
                        icon: L.divIcon({
                            html: '<i class="fas fa-shopping-basket" style="color: #e83e8c; font-size: 18px;"></i>',
                            className: '',
                            iconSize: [20, 20]
                        })
                    });
                },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(createPopup(feature.properties));
                }
            }).addTo(map);
        }
        
        // UMKM LAYER
        if (typeof json_UMKM_23 !== 'undefined') {
            layerMap.umkm = L.geoJSON(json_UMKM_23, {
                pointToLayer: function(feature, latlng) {
                    if (feature.properties.UMKM) {
                        searchData.push({
                            name: feature.properties.UMKM,
                            lat: latlng.lat,
                            lng: latlng.lng,
                            type: 'UMKM'
                        });
                    }
                    return L.marker(latlng, {
                        icon: L.divIcon({
                            html: '<i class="fas fa-store-alt" style="color: #6f42c1; font-size: 18px;"></i>',
                            className: '',
                            iconSize: [20, 20]
                        })
                    });
                },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(createPopup(feature.properties));
                }
            }).addTo(map);
        }
        
        // ==================== SEARCH FUNCTIONALITY ====================
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        
        searchInput.addEventListener('input', function() {
            const query = this.value.toLowerCase().trim();
            
            if (query.length < 2) {
                searchResults.style.display = 'none';
                return;
            }
            
            const filtered = searchData.filter(item => {
                const itemName = item.name.toLowerCase();
                const queryWords = query.split(' ');
                return queryWords.every(word => itemName.includes(word));
            });
            
            if (filtered.length > 0) {
                searchResults.innerHTML = filtered.slice(0, 10).map(item => 
                    `<div class="search-result-item" onclick="zoomToLocation(${item.lat}, ${item.lng}, '${item.name.replace(/'/g, "\\'")}')">
                        <div>${item.name}</div>
                        <div class="search-result-type">${item.type}</div>
                    </div>`
                ).join('');
                searchResults.style.display = 'block';
            } else {
                searchResults.innerHTML = '<div class="search-result-item" style="color: #999;">Tidak ditemukan</div>';
                searchResults.style.display = 'block';
            }
        });
        
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-box')) {
                searchResults.style.display = 'none';
            }
        });
        
        function zoomToLocation(lat, lng, name) {
            map.setView([lat, lng], 17);
            L.popup()
                .setLatLng([lat, lng])
                .setContent(`<strong>${name}</strong>`)
                .openOn(map);
            searchResults.style.display = 'none';
            searchInput.value = '';
        }
        
        // Bring basemap to back
        currentBasemap.bringToBack();
        
        console.log('‚úÖ WebGIS Desa Badamita berhasil dimuat!');
        console.log(`üìç Total lokasi yang dapat dicari: ${searchData.length}`);

    </script>
</body>
</html>

