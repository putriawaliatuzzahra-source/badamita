<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<title>WebGIS Desa Badamita</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- CSS -->
<link rel="stylesheet" href="css/leaflet.css">
<link rel="stylesheet" href="css/leaflet-search.css">
<link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
<link rel="stylesheet" href="css/L.Control.Locate.min.css">

<style>
html, body {height:100%;margin:0;font-family:Arial,sans-serif;}
#header{
  height:50px;
  background:#2C3E50;
  color:#ECF0F1;
  display:flex;
  align-items:center;
  padding:0 20px;
  font-weight:bold;
  font-size:18px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}
#map{width:100%;height:calc(100% - 50px);}
.leaflet-control-search input{width:260px!important;}
</style>
</head>

<body>
<div id="header">üåç WebGIS Desa Badamita</div>
<div id="map"></div>

<!-- JS -->
<script src="js/leaflet.js"></script>
<script src="js/leaflet-search.js"></script>
<script src="js/L.Control.Layers.Tree.min.js"></script>
<script src="js/L.Control.Locate.min.js"></script>

<!-- DATA -->
<script src="data/BatasWilayahDesa_1.js"></script>
<script src="data/DesaBadamita_2.js"></script>
<script src="data/Sawah_3.js"></script>
<script src="data/Kebun_4.js"></script>
<script src="data/LapanganDesa_5.js"></script>
<script src="data/RW5GENDANI_6.js"></script>
<script src="data/RW4SOKARAJA_7.js"></script>
<script src="data/RW3PAGUAN_8.js"></script>
<script src="data/RW2KARANGSAGA_9.js"></script>
<script src="data/RW1BADAMITA_10.js"></script>
<script src="data/RTDIRW5GENDANI_11.js"></script>
<script src="data/RTDIRW4SOKARAJA_12.js"></script>
<script src="data/RTDIRW3PAGUAN_13.js"></script>
<script src="data/RTDIRW2KARANGSAGA_14.js"></script>
<script src="data/RTDIRW1BADAMITA_15.js"></script>
<script src="data/JlRayaGendani_16.js"></script>
<script src="data/JlRayaSokaraja_17.js"></script>
<script src="data/JlRayaPaguan_18.js"></script>
<script src="data/JlRayaKarangsaga_19.js"></script>
<script src="data/JlRayaBadamita_20.js"></script>
<script src="data/Sungai_21.js"></script>
<script src="data/building_22.js"></script>
<script src="data/Sekolah_23.js"></script>
<script src="data/TempatPemakaman_24.js"></script>
<script src="data/PomMini_25.js"></script>
<script src="data/BengkelMobilMotor_26.js"></script>
<script src="data/Pasar_27.js"></script>
<script src="data/UMKM_28.js"></script>
<script src="data/Market_29.js"></script>
<script src="data/Alfamart_30.js"></script>
<script src="data/TempatIbadah_31.js"></script>
<script src="data/FasilitasKesehatan_32.js"></script>
<script src="data/KetuaRW_33.js"></script>
<script src="data/RumahPutriAwaliatuz_34.js"></script>
<script src="data/BalaiDesa_35.js"></script>

<script>
// ================= INIT MAP =================
var map = L.map('map').setView([-7.40, 109.555], 14);

// ================= BASE MAP =================
var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 20, attribution:'&copy; OSM'});
var satellite = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {maxZoom: 20});
var terrain = L.tileLayer('https://mt1.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', {maxZoom: 20});
osm.addTo(map);

// ================= CONTROL ZOOM & LOCATE =================
L.control.zoom({position:'topleft'}).addTo(map);
L.control.locate({position:'topleft'}).addTo(map);

// ================= SEARCH GROUP =================
var searchGroup = new L.FeatureGroup().addTo(map);

// ================= UNIVERSAL SEARCH =================
function registerSearch(feature, layer, label){
  var p = feature.properties || {};
  var value = null;
  var keys = ['Nama','nama','Nama_UMKM','Nama_Sekolah','Nama_Pemilik','Nama_RW','Nama_RT','Nama_Bangunan','NAMOBJ','Nama_Fasilitas','Nama_Lapangan'];
  for(var i=0;i<keys.length;i++){ if(p[keys[i]]){ value=p[keys[i]]; break; } }
  if(!value){
    for(var k in p){
      if(typeof p[k]==='string' && isNaN(p[k])){ value=p[k]; break; }
    }
  }
  if(value){
    feature.properties.__search = label + " : " + value;
    searchGroup.addLayer(layer);
  }
}

// ================= LAYER FUNCTIONS =================
function polygonLayer(json,color,label){ 
  return L.geoJson(json,{
    style:{color:color,weight:2,fillOpacity:0.3},
    onEachFeature:function(f,l){
      var name = f.properties.Nama || f.properties.NAMOBJ || label;
      l.bindPopup(name);
      registerSearch(f,l,label);
    }
  });
}

function lineLayer(json,color,label){
  return L.geoJson(json,{
    style:{color:color,weight:3},
    onEachFeature:function(f,l){
      var name = f.properties.Nama || label;
      l.bindPopup(name);
      registerSearch(f,l,label);
    }
  });
}

function pointLayer(json,icon,label){
  return L.geoJson(json,{
    pointToLayer:(f,ll)=>L.marker(ll,{icon:L.icon({iconUrl:icon,iconSize:[20,20]})}),
    onEachFeature:function(f,l){
      var name = f.properties.Nama || f.properties.Nama_Sekolah || f.properties.Nama_UMKM || f.properties.Nama_Pemilik || f.properties.Nama_Bangunan || label;
      l.bindPopup(name);
      registerSearch(f,l,label);
    }
  });
}

// ================= LOAD LAYERS =================
var batas = polygonLayer(json_BatasWilayahDesa_1,'#D9534F','Batas Desa');
var desa  = polygonLayer(json_DesaBadamita_2,'#F0AD4E','Desa');
var sawah = polygonLayer(json_Sawah_3,'#A9DFBF','Sawah');
var kebun = polygonLayer(json_Kebun_4,'#82E0AA','Kebun');
var bangunan = polygonLayer(json_building_22,'#F7DC6F','Bangunan');

// Layer RW
var RW1 = polygonLayer(json_RW1BADAMITA_10,'#1ABC9C','RW 1');
var RW2 = polygonLayer(json_RW2KARANGSAGA_9,'#1ABC9C','RW 2');
var RW3 = polygonLayer(json_RW3PAGUAN_8,'#1ABC9C','RW 3');
var RW4 = polygonLayer(json_RW4SOKARAJA_7,'#1ABC9C','RW 4');
var RW5 = polygonLayer(json_RW5GENDANI_6,'#1ABC9C','RW 5');

// Layer RT
var RT1 = polygonLayer(json_RTDIRW1BADAMITA_15,'#3498DB','RT 1');
var RT2 = polygonLayer(json_RTDIRW2KARANGSAGA_14,'#3498DB','RT 2');
var RT3 = polygonLayer(json_RTDIRW3PAGUAN_13,'#3498DB','RT 3');
var RT4 = polygonLayer(json_RTDIRW4SOKARAJA_12,'#3498DB','RT 4');
var RT5 = polygonLayer(json_RTDIRW5GENDANI_11,'#3498DB','RT 5');

var jalan = L.layerGroup([
  lineLayer(json_Sungai_21,'#BDC3C7','Sungai'),
  lineLayer(json_JlRayaGendani_16,'#BDC3C7','Jalan'),
  lineLayer(json_JlRayaSokaraja_17,'#BDC3C7','Jalan'),
  lineLayer(json_JlRayaPaguan_18,'#BDC3C7','Jalan'),
  lineLayer(json_JlRayaKarangsaga_19,'#BDC3C7','Jalan'),
  lineLayer(json_JlRayaBadamita_20,'#BDC3C7','Jalan')
]);

var fasilitas = L.layerGroup([
  pointLayer(json_Sekolah_23,'markers/Sekolah_23.svg','Sekolah'),
  pointLayer(json_Pasar_27,'markers/Pasar_27.svg','Pasar'),
  pointLayer(json_UMKM_28,'markers/UMKM_28.svg','UMKM'),
  pointLayer(json_Alfamart_30,'markers/Alfamart_30.svg','Alfamart'),
  pointLayer(json_TempatIbadah_31,'markers/TempatIbadah_31.svg','Tempat Ibadah'),
  pointLayer(json_FasilitasKesehatan_32,'markers/FasilitasKesehatan_32.svg','Faskes'),
  pointLayer(json_RumahPutriAwaliatuz_34,'markers/RumahPutriAwaliatuz_34.svg','Rumah'),
  pointLayer(json_BalaiDesa_35,'markers/BalaiDesa_35.svg','Balai Desa'),
  pointLayer(json_TempatPemakaman_24,'markers/TempatPemakaman_24.svg','Pemakaman'),
  pointLayer(json_PomMini_25,'markers/PomMini_25.svg','Pom Mini'),
  pointLayer(json_BengkelMobilMotor_26,'markers/BengkelMobilMotor_26.svg','Bengkel'),
  pointLayer(json_Market_29,'markers/Market_29.svg','Market'),
  pointLayer(json_KetuaRW_33,'markers/ketuaRW_33.svg','Ketua RW')

]);

// ================= SEARCH CONTROL =================
var search = new L.Control.Search({
  layer: searchGroup,
  propertyName: '__search',
  marker:false,
  collapsed:false,
  textPlaceholder:'Cari semua data (Sekolah, UMKM, RT, RW, Bangunan, Jalan...)'
}).addTo(map);

search.on('search:locationfound', function(e) {
  map.setView(e.latlng, 18);
  if(e.layer.getPopup()) e.layer.openPopup();

  // Pastikan layer jalan yang bersangkutan terlihat
  if(e.layer.feature && e.layer.feature.geometry.type === "LineString") {
    if(!map.hasLayer(jalan)) {
      map.addLayer(jalan);
    }
  }
});


// ================= BASEMAP & OVERLAY =================
var baseMaps = {
  "OSM": osm,
  "Satellite": satellite,
  "Terrain": terrain
};

var overlayMaps = {
  "Administrasi": L.layerGroup([batas, desa]),
  "Lahan": L.layerGroup([sawah, kebun]),
  "Bangunan": bangunan,
  "Jalan": jalan,
  "Sekolah": pointLayer(json_Sekolah_23,'markers/Sekolah_23.svg','Sekolah'),
  "UMKM": pointLayer(json_UMKM_28,'markers/UMKM_28.svg','UMKM'),
  "Tempat Ibadah": pointLayer(json_TempatIbadah_31,'markers/TempatIbadah_31.svg','Tempat Ibadah'),
  "Fasilitas Kesehatan": pointLayer(json_FasilitasKesehatan_32,'markers/FasilitasKesehatan_32.svg','Faskes'),
  "Pasar": pointLayer(json_Pasar_27,'markers/Pasar_27.svg','Pasar'),
  "Alfamart": pointLayer(json_Alfamart_30,'markers/Alfamart_30.svg','Alfamart'),
  "Pom Mini": pointLayer(json_PomMini_25,'markers/PomMini_25.svg','Pom Mini'),
  "Bengkel Mobil Motor": pointLayer(json_BengkelMobilMotor_26,'markers/BengkelMobilMotor_26.svg','Bengkel'),
  "Market": pointLayer(json_Market_29,'markers/Market_29.svg','Market'),
  "Tempat Pemakaman": pointLayer(json_TempatPemakaman_24,'markers/TempatPemakaman_24.svg','Pemakaman'),
  "Sungai": lineLayer(json_Sungai_21,'markers/Sungai_21.svg','Sungai')
};

L.control.layers(baseMaps, overlayMaps,{collapsed:false,position:'topright'}).addTo(map);

</script>
</body>
</html>
